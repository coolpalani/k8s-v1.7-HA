---

- name: Get failed kube-dns pods
#  shell: kubectl get pods --namespace=kube-system |grep -i kube-dns |egrep  "CrashLoopBackOff|Error"
  shell: kubectl get pods --namespace=kube-system |grep -i kube-dns
  register: failed_kubedns_pod
  ignore_errors: true

- name: Delete failed pods
  shell: kubectl delete deployment kube-dns --namespace=kube-system
  register: del_dns_deployment
  when: failed_kubedns_pod | succeeded
  ignore_errors: true

- name: Remove remaining kube-dns component
  command: kubectl delete "{{item}}" kube-dns --namespace=kube-system
  with_items:
    - Service
    - ConfigMap
    - ServiceAccount
  when: del_dns_deployment | succeeded
  ignore_errors: true
  

#- name: Create kubedns deployment
#  command: kubectl create -f {{kube_dns_yaml}}

#- name: Get kubedns deployment status
#  shell: kubectl get pods -l k8s-app=kube-dns -n kube-system -o wide
#  register: get_kubedns_deployment
#- debug:
#    var: get_kubedns_deployment.stdout
